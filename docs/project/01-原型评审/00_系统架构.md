# YBP 系统原型设计

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         YBP 系统                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────┐          ┌─────────────────┐                 │
│   │   Web 管理端    │          │  Revit 插件端   │                 │
│   │                 │          │                 │                 │
│   │ • 品目管理      │          │ • 族上传        │                 │
│   │ • 清单关联      │          │ • 族库浏览      │                 │
│   │ • 参数配置      │          │ • 族下载        │                 │
│   │ • 匹配规则      │          │ • 模型上传      │                 │
│   │                 │          │                 │                 │
│   └────────┬────────┘          └────────┬────────┘                 │
│            │                            │                           │
│            └──────────┬─────────────────┘                           │
│                       ▼                                             │
│            ┌─────────────────────┐                                  │
│            │     后端服务        │                                  │
│            │                     │                                  │
│            │ • 参数解析          │                                  │
│            │ • 清单匹配引擎      │                                  │
│            │ • 工程量计算        │                                  │
│            │                     │                                  │
│            └─────────────────────┘                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、品目管理

### 2.1 品目层级结构

```
品目
│
├── 基本信息
│   ├── 品目名称
│   └── 品目描述
│
├── 关联清单
│   └── 选择与该品目相关的所有清单（待匹配池）
│
├── 品目参数
│   ├── 构件属性（用于清单匹配）
│   └── 工程量属性（用于出量计算）
│
└── 品目类型（预设族类型）
    ├── 品目类型1
    ├── 品目类型2
    └── ...
```

### 2.2 品目参数详解

#### 构件属性

用于清单匹配的参数配置。

**新增参数时**：
- 名称与族参数一致 → 引用
- 名称与族参数不一致 → 新增（可选类型/实例参数）

**配置项**：
| 字段 | 说明 |
|-----|------|
| 名称 | 参数名称 |
| 单位 | 如 M3/H、mm、m² |
| 输入方式 | 数值框、文本框、下拉选择 |
| 选项值 | 下拉选择时的可选项 |

#### 工程量属性

用于计算工程量的配置，由易达定制开发。

---

## 三、清单匹配配置

### 3.1 配置方式

**从清单出发**，每个清单配置「匹配条件」：

```
品目：新风机
│
├── 关联清单
│   ├── 清单A: 新风机(≥4000)
│   │   └── 匹配条件: 风量 >= 4000
│   │
│   ├── 清单B: 新风机(2000-4000)
│   │   └── 匹配条件: 风量 >= 2000 AND 风量 < 4000
│   │
│   └── 清单C: 新风机(<2000)
│       └── 匹配条件: 风量 < 2000
```

### 3.2 匹配条件配置

```
匹配条件
├── 引用参数：选择构件属性中的参数
├── 运算符：=、!=、>、>=、<、<=
├── 值：具体数值或选项
└── 多条件：AND 逻辑组合
```

---

## 四、完整工作流程

### 4.1 配置阶段

```
┌─────────────────────────────────────────────────────────────────────┐
│                        1. 上传族                                     │
├─────────────────────────────────────────────────────────────────────┤
│   Revit 插件 → 选择品目 → 上传 .rfa/.rvt → 解析参数 → 存入系统      │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        2. 关联清单                                   │
├─────────────────────────────────────────────────────────────────────┤
│   Web 端 → 品目管理 → 选择该品目可能匹配的所有清单                   │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        3. 配置构件属性                               │
├─────────────────────────────────────────────────────────────────────┤
│   Web 端 → 品目参数 → 构件属性 → 新增/引用参数                       │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        4. 配置匹配条件                               │
├─────────────────────────────────────────────────────────────────────┤
│   Web 端 → 每个清单 → 配置匹配条件（引用参数 + 规则）                │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        5. 配置工程量属性                             │
├─────────────────────────────────────────────────────────────────────┤
│   告诉易达需要的工程量计算方式 → 易达定制开发                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 建模阶段

```
┌─────────────────────────────────────────────────────────────────────┐
│                        6. 建模员使用                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Revit 插件 → 族库浏览 → 选择品目/品目类型 → 下载族                 │
│                                                                     │
│   系统构件属性 与 Revit 族参数 合并：                                │
│       • Revit 有该参数 → 系统引用                                   │
│       • Revit 无该参数 → API 写入族                                 │
│                                                                     │
│   建模员使用族 → 按需修改实例参数                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 匹配阶段

```
┌─────────────────────────────────────────────────────────────────────┐
│                        7. 导出 BIM 数据包                            │
├─────────────────────────────────────────────────────────────────────┤
│   建模完成 → Revit 插件导出 BIM 数据包（含族实例参数信息）           │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        8. 新建项目并上传                             │
├─────────────────────────────────────────────────────────────────────┤
│   YBP Web 端 → 新建项目 → 上传 BIM 数据包                           │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        9. 清单匹配                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   遍历每个族实例                                                     │
│       ↓                                                             │
│   读取参数值                                                         │
│       ↓                                                             │
│   找到对应品目                                                       │
│       ↓                                                             │
│   遍历该品目关联的清单                                               │
│       ↓                                                             │
│   检查匹配条件                                                       │
│       ↓                                                             │
│   条件满足 → 带出清单                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        10. 工程量计算                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   按清单分组                                                         │
│       ↓                                                             │
│   根据工程量属性配置                                                 │
│       ↓                                                             │
│   计算每个清单的工程量                                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        11. 输出结果                                  │
├─────────────────────────────────────────────────────────────────────┤
│   清单列表 + 各清单工程量 → 用于采购、成本计算                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 五、与 YDC 的对比

| 维度 | YDC（现有） | YBP（开发中） |
|-----|------------|--------------|
| 清单匹配 | 手动填充 | 自动匹配 |
| 工程量 | 手动导出明细表 | 自动计算 |
| 族类型 | 需预设所有可能 | 参数区间匹配，一个默认即可 |
| 参数 | 类型参数为主 | 实例参数为主 |

---

## 六、技术要点

### 6.1 Revit 插件

- 族上传与参数解析
- 族库浏览与下载
- 系统参数写入族（API）
- 模型信息导出

### 6.2 Web 端

- 品目管理界面
- 清单关联与匹配条件配置
- 构件属性管理
- 结果展示

### 6.3 后端

- 参数解析与存储
- 清单匹配引擎
- 工程量计算逻辑
- 数据接口

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | - | 初稿 |
