# 清单匹配逻辑

## 一、核心目标

**输入**：建模完成的 Revit 模型（包含多个族实例）
**输出**：每个族实例对应的清单

**核心问题**：如何根据族实例的参数，自动匹配到正确的清单？

---

## 二、匹配方式演进

### 2.1 早期简单逻辑（YBP 初版）

**思路**：品目类型 ↔ 清单 直接对应

```
品目（新风机）
├── 品目类型1（3000M3/H）→ 清单A
├── 品目类型2（5000M3/H）→ 清单B
└── 品目类型3（7000M3/H）→ 清单C
```

**限制**：需要提前建立所有可能的品目类型，对于连续参数（如任意风量值）无法穷举。

### 2.2 优化后逻辑（参数区间匹配）

**思路**：根据参数值的区间判断，动态匹配清单

```
品目（新风机）
└── 品目类型（默认1个即可）
    │
    参数：风量（实例参数，建模时可改）
    │
    匹配规则：
    ├── 风量 >= 4000     → 清单A
    ├── 2000 <= 风量 < 4000 → 清单B
    └── 风量 < 2000      → 清单C
```

**优势**：无需预设所有品目类型，一个默认即可，参数任意值都能匹配。

---

## 三、当前匹配机制（YBP 原型）

### 3.1 配置方式

**从清单出发配置匹配条件**（易达设计）：

```
清单A: 新风机(≥4000)
└── 匹配条件: 风量 >= 4000

清单B: 新风机(2000-4000)
└── 匹配条件: 风量 >= 2000 AND 风量 < 4000

清单C: 新风机(<2000)
└── 匹配条件: 风量 < 2000
```

### 3.2 匹配流程

```
上传模型
    ↓
读取族实例参数（如：风量 = 3500）
    ↓
遍历该品目关联的所有清单
    ↓
检查每个清单的匹配条件
    ↓
条件满足 → 带出该清单
```

---

## 四、匹配条件类型

### 4.1 无条件匹配（全匹配）

所有族实例都带出该清单。

**场景**：排风扇 → 不管参数如何，都带出「排风扇电源」清单

```
清单: 排风扇电源
└── 匹配条件: 无（或"任意"）
```

### 4.2 单参数区间匹配

根据一个参数的值进行区间判断。

**场景**：新风机按风量匹配

```
清单: 新风机(≥4000)
└── 匹配条件: 风量 >= 4000
```

### 4.3 单参数精确匹配

根据一个参数的精确值匹配。

**场景**：楼板按结构材质匹配

```
清单: 150x150mm灰色砖地面
└── 匹配条件: 结构材质 = "厨房灰色砖"
```

### 4.4 多参数联合匹配（AND）

多个条件同时满足才匹配。

**场景**：楼板按结构材质 + 品牌匹配

```
清单: 150x150mm灰色砖地面（琛雄）
└── 匹配条件: 结构材质 = "厨房灰色砖" AND 品牌 = "琛雄"

清单: 150x150mm灰色砖地面（共荣）
└── 匹配条件: 结构材质 = "厨房灰色砖" AND 品牌 = "共荣"
```

### 4.5 多参数区间联合匹配

多个参数都进行区间判断。

**场景**：某设备同时看风量和功率

```
清单: 大功率高风量设备
└── 匹配条件: 风量 >= 4000 AND 功率 >= 500
```

---

## 五、匹配条件配置结构

```json
{
  "清单名称": "新风机(2000-4000)",
  "匹配条件": {
    "逻辑": "AND",
    "条件组": [
      { "参数": "风量", "运算符": ">=", "值": 2000 },
      { "参数": "风量", "运算符": "<", "值": 4000 }
    ]
  }
}
```

**支持的运算符**：
- `=`：等于
- `!=`：不等于
- `>`、`>=`：大于、大于等于
- `<`、`<=`：小于、小于等于
- `range`：区间（可简化配置）

---

## 六、一个品目类型对应多个清单

**场景**：排风扇，一个品目类型需要带出 3 个清单

```
品目（排风扇）
└── 品目类型（排风扇）
    │
    清单1: 小型排风扇安装（不含主材）→ 匹配条件: 无
    清单2: 供应(不含安装)小型排风扇  → 匹配条件: 无
    清单3: 小型排风扇电源            → 匹配条件: 无
```

**结果**：每个排风扇族实例都带出 3 个清单。

---

## 七、匹配逻辑总结

| 场景 | 匹配方式 | 示例 |
|-----|---------|------|
| 固定清单 | 无条件 | 排风扇 → 电源清单 |
| 按规格区分 | 单参数区间 | 新风机按风量 |
| 按材质区分 | 单参数精确 | 楼板按结构材质 |
| 按材质+品牌 | 多参数精确 | 楼板按材质+品牌 |
| 复杂设备 | 多参数区间 | 按风量+功率 |

---

## 八、注意事项

1. **清单不重叠**：设计上保证不同清单的匹配条件不重叠，避免一个族实例匹配到多个同类清单
2. **条件组内 AND**：多个条件必须同时满足
3. **一个族实例可带出多个清单**：如排风扇带出安装+供应+电源 3 个清单
4. **参数来源**：可以是族本身的参数，也可以是系统新增的参数

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | - | 初稿 |
