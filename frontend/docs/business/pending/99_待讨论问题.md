# 待讨论问题

本文档汇总当前系统设计中尚未解决或需要进一步讨论的问题。

---

## 一、幕墙工程量计算

### 问题描述

幕墙的工程量计算涉及跨构件运算：

```
幕墙工程量 = 幕墙面积 - 嵌板面积
```

### 幕墙结构

```
幕墙（整体）
├── 嵌板（门/墙）
└── 框
```

### 现状

- YDC 系统中，建模员手动出明细表
- 手动做减法计算
- 效率低，易出错

### 待解决

1. **跨构件关联**：如何在系统中识别幕墙与其嵌板的从属关系？
2. **自动计算**：如何实现自动的减法运算？
3. **数据结构**：是否需要特殊的数据结构来支持这种关联？

### 可能方案（待讨论）

- 方案A：Revit 插件导出时带出关联信息
- 方案B：系统层面建立父子构件关系
- 方案C：易达定制开发特殊出量逻辑

---

## 二、工程量属性定制开发

### 问题描述

目前工程量计算逻辑由易达定制开发：

- 用户告诉易达需要什么工程量
- 易达编写出量逻辑
- 这种模式的灵活性和可扩展性如何保证？

### 待讨论

1. **标准化**：是否可以抽象出通用的计算规则？
2. **自定义公式**：是否需要支持用户自定义计算公式？
3. **维护成本**：每新增一种计算方式都需要开发介入？

---

## 三、参数同步机制

### 问题描述

系统参数与 Revit 参数的同步：

```
系统新增参数 → API 写入族 → 建模员修改 → 上传回系统
```

### 待明确

1. **冲突处理**：如果系统和 Revit 中参数值不一致，以哪边为准？
2. **版本控制**：参数配置变更后，已下载的族如何处理？
3. **批量更新**：是否支持批量更新已放置族实例的参数？

---

## 四、清单库及版本维护

### 问题描述

清单数据从何而来？如何维护？版本如何管理？

### 初步方案（黄增沛 2025-11-25）

1. **架构**：沿用单价库 + 清单的方式
2. **版本策略**：
   - ❌ 去除大版本
   - ✅ 版本精确到**清单级别**
3. **核心识别**：清单编码 + 清单名称
4. **业态扩展**：切换业态（YDC、YBP）时增加扩展识别码
   - YDC 示例：co, pmtCode, assetCode, beType

### 待确认

1. [ ] 对比 YDC、汉堡王、奥乐齐的清单结构
2. [ ] 确认版本精确到清单级别的具体实现
3. [ ] YBP 业态的扩展识别码定义

---

## 五、多项目支持

### 问题描述

系统是否需要支持多项目隔离？

### 待讨论

1. **品目库**：是全局共享还是项目独立？
2. **族库**：不同项目可能有不同的族配置
3. **清单库**：不同项目使用不同的清单标准

---

## 六、权限与角色

### 问题描述

系统中不同角色的权限划分。

### 可能的角色

| 角色 | 职责 | 权限 |
|-----|------|------|
| 管理员 | 系统配置 | 全部 |
| 品目管理员 | 维护品目、清单关联 | 品目管理、清单配置 |
| 建模员 | 使用族库建模 | 族下载、模型上传 |
| 查看者 | 查看结果 | 只读 |

### 待讨论

1. **角色定义**：需要哪些角色？
2. **权限粒度**：权限划分到什么程度？
3. **数据隔离**：不同角色看到的数据范围？

---

## 七、异常处理

### 问题描述

各种异常情况的处理策略。

### 场景列表

| 异常场景 | 当前处理 | 待讨论 |
|---------|---------|--------|
| 族实例未匹配到清单 | ? | 是否报警？默认清单？ |
| 参数值缺失 | ? | 跳过？默认值？ |
| 匹配到多个清单（非一对多场景） | ? | 优先级？报错？ |
| 几何参数值异常 | ? | 由 Revit 保证？ |

---

## 八、性能与规模

### 问题描述

系统需要支持的数据规模。

### 待明确

1. **族库规模**：预计有多少个品目？多少个族类型？
2. **模型规模**：单个模型最大多少族实例？
3. **并发需求**：多少用户同时使用？

---

## 九、集成对接

### 问题描述

与其他系统的集成需求。

### 可能的对接

- 采购系统：清单 + 工程量 + 单价
- 成本系统：成本分析
- 项目管理系统：进度关联
- ERP 系统：资源计划

### 待讨论

1. **接口标准**：采用什么数据格式？
2. **实时性**：实时对接还是批量导出？
3. **双向同步**：是否需要从外部系统同步数据？

---

## 十、插件开发

### 问题描述

Revit 插件端需要提供哪些功能？

### 当前状态（2025-11-25）

- 功能点在原型中有初步体现
- 可能包含在本次评审内（需与游工确认）

### 待确认

1. [ ] 插件端需要配给什么功能点？
2. [ ] 实现什么效果？
3. [ ] 基于甲方项目清单，涉及哪些需要开发代码提量的清单？
4. [ ] 提量规则是什么？

### 已知功能点（原型）

- 族上传
- 族库浏览
- 族下载
- 模型上传

---

## 十一、完整链路待确认

### 核心流程

```
维护族库 → 下载建模 → 上传数据 → 带出清单 → 计算工程量
```

### 关键澄清（游工 2025-11-25）

- 建模上传带出的是**含模型数据与参数的轻量化包**
- 清单需要在**系统中生成**（不是直接带出清单）

### 各环节状态

| 环节 | 负责方 | 状态 |
|-----|--------|------|
| 族维护 | - | ✅ 已讨论 |
| 插件下载/上传 | 游工？ | ⏳ 待确认 |
| 系统匹配 | 易达 | ⏳ 待确认 |
| 清单生成 | 黄增沛 | 🔄 有思路 |
| 工程量计算 | 易达 | ✅ 已可用 |

---

## 十二、工程量计算技术实现（重点）

> 2025-11-27 新增 - Stephen 负责推进

### 问题描述

需要搞清楚易达工程量计算的技术实现方式，为后续功能开发做准备。

### 核心问题

| 问题 | 说明 | 状态 |
|------|------|------|
| 计算在哪执行？ | Revit 插件端 vs 系统服务器端 | 待确认 |
| 规则如何配置？ | 系统端配置界面/方式 | 待确认 |
| 规则如何传递？ | Revit 如何识别/解码配置的规则 | 待确认 |
| 引擎如何调用？ | Revit API 的具体使用方式 | 待确认 |

### 李昱给出的方向

```
计算流程:
  1. 系统配置计算规则
  2. Revit 解码规则
  3. 调用 Revit API 底层计算引擎
  4. 输出工程量

原则：不要写死，功能解耦
```

### 具体案例：幕墙-门

```
幕墙面积计算
├── 配置选项：是否扣除门的面积
│   ├── 扣除 → 幕墙面积 - 门面积
│   └── 不扣除 → 幕墙面积
└── 用户配置时可选择
```

### 待调研

1. [ ] 试用系统端计算功能（黄增沛说已可用）
2. [ ] 了解现有计算规则的配置方式
3. [ ] 梳理需要支持的清单类型和计算规则
4. [ ] 确认 Revit API 计算引擎的能力边界

---

## 十三、评审进度追踪

### 当前状态（2025-11-27）

- 评审排队中，即将评审
- 插件开发可能在评审范围内（待确认）

### 待确认事项

- [ ] 评审的具体内容是什么？
- [ ] 插件、系统端生成清单、工程量是否受评审阻塞？
- [ ] 两部分耦合程度如何？

### 评审后待办

- [ ] 根据评审结果调整方案
- [ ] 确认插件开发是否在范围内
- [ ] 安排后续开发计划

---

## 十三、历史讨论记录

### 已确定的方案

| 问题 | 确定方案 | 确定时间 |
|-----|---------|---------|
| 叠层墙处理 | 拆分到基本墙处理 | - |
| 参数区间匹配 | 使用范围运算符 | - |
| 一对多清单 | 无条件全匹配 | - |
| 几何参数 | 系统只读，不可修改 | - |

### 待确定的方案

| 问题 | 候选方案 | 优先级 |
|-----|---------|--------|
| 幕墙工程量 | 待讨论 | 高 |
| 工程量自定义公式 | 待讨论 | 中 |
| 清单库来源 | 待讨论 | 中 |

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | - | 初稿 |
| v2.0 | 2025-11-25 | 更新清单库方案、添加插件开发、完整链路、评审追踪 |
| v3.0 | 2025-11-27 | 新增「工程量计算技术实现」章节（重点），更新评审状态 |
