# 系统健康排查与优化指南

> 当项目混乱时，如何系统性排查和恢复 - 完整的诊断与优化流程

**文档性质**: 独立参考指南（可复用于任何项目）
**创建日期**: 2025-11-23
**维护者**: Stephen Kaylon Chan
**适用场景**: 文档混乱、代码冗余、误操作后恢复、定期健康检查

---

## 📖 目录

1. [什么是系统排查](#1-什么是系统排查)
2. [混乱信号识别](#2-混乱信号识别)
3. [排查范围与检查清单](#3-排查范围与检查清单)
4. [详细排查步骤](#4-详细排查步骤)
5. [优化策略](#5-优化策略)
6. [恢复机制](#6-恢复机制)
7. [预防措施](#7-预防措施)
8. [实际案例](#8-实际案例)

---

## 1. 什么是系统排查

### 1.1 定义

**系统排查**是对整个项目进行全面健康检查的过程，包括：
- 文档系统（完整性、一致性、冗余）
- 代码质量（ESLint、未使用依赖）
- Git 历史（commit 质量、未提交文件）
- 依赖健康（过时依赖、安全漏洞）
- 性能指标（构建时间、产物大小）

### 1.2 目的

- **诊断问题**：发现系统中的混乱点
- **优化质量**：删除冗余、提升效率
- **恢复秩序**：从混乱中恢复到正常状态
- **预防未来**：建立预防机制，避免再次混乱

### 1.3 适用场景

**🔴 紧急排查**（系统已混乱）：
- 误操作导致文档混乱
- 代码冗余，难以维护
- Git 历史混乱，commit 质量差
- AI 无法正确理解项目状态

**🟡 定期排查**（预防性检查）：
- 每周日执行 `/audit --quick`（快速检查）
- 每月初执行 `/audit --full`（完整检查）
- 重大功能完成后执行全面排查

**🟢 优化排查**（持续改进）：
- Token 消耗过高，需要优化
- 文档过时，需要更新
- 依赖过时，需要升级

---

## 2. 混乱信号识别

### 2.1 文档系统混乱信号

**🔴 Critical（立即处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **CURRENT.md 超过 5000 tokens** | 文档膨胀，未归档 | AI 恢复上下文慢，Token 浪费 |
| **CONTEXT.md 与实际不符** | 状态过时（如"Phase 1"，实际已 Phase 3） | AI 理解错误，建议不准确 |
| **文档链接失效** | 文档中的链接指向不存在的文件 | 用户体验差，信息检索困难 |
| **文档重复** | 多个文档记录相同内容 | 维护成本高，信息不一致 |

**🟡 Warning（本周处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **CURRENT.md 冗余内容** | 重复日志、过度详细 | Token 消耗增加 |
| **文档未与代码同步** | components.md 缺少新组件 | 文档价值降低 |
| **ADR 缺失** | 重大决策无 ADR 记录 | 决策难以追溯 |
| **troubleshooting 过时** | 已修复的 bug 未删除 | 文档混乱，难以查找 |

**🟢 Info（月度处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **archive 超过 6 个月** | 历史归档过多 | 磁盘占用，影响 Git 性能 |
| **tech-stack.md 版本不一致** | 与 package.json 不符 | 文档价值降低 |

### 2.2 代码系统混乱信号

**🔴 Critical（立即处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **ESLint errors > 10** | 代码质量问题严重 | 运行时错误风险高 |
| **安全漏洞（Critical/High）** | 依赖存在严重安全漏洞 | 安全风险 |
| **未提交文件 > 20 个** | Git 状态混乱 | 版本控制失控 |
| **构建失败** | 项目无法构建 | 无法部署 |

**🟡 Warning（本周处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **ESLint warnings > 50** | 代码质量需要改进 | 潜在问题风险 |
| **未使用依赖 > 5 个** | 依赖冗余 | 构建产物大，安全风险 |
| **过时依赖 > 10 个** | 依赖版本过旧 | 错失性能优化、bug 修复 |
| **代码 TODO/FIXME > 20 个** | 技术债务积累 | 维护成本增加 |

**🟢 Info（月度处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **构建时间 > 5 秒** | 构建性能下降 | 开发体验差 |
| **产物大小 > 3MB** | 打包产物过大 | 加载速度慢 |

### 2.3 Git 历史混乱信号

**🔴 Critical（立即处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **最新 10 个 commit 都是"fix"** | Commit 质量差，未使用规范 | Git 历史难以阅读 |
| **有 merge commit 冲突** | 分支合并冲突未解决 | 代码可能有问题 |
| **未推送 commit > 20 个** | 本地代码未同步到远程 | 数据丢失风险 |

**🟡 Warning（本周处理）**：

| 信号 | 描述 | 影响 |
|------|------|------|
| **Commit message 不规范** | 未使用 Conventional Commits | Git 历史难以阅读 |
| **单个 commit 修改 > 100 文件** | Commit 粒度太大 | 难以回滚、难以 review |
| **连续 3 天没有 commit** | 开发进度未记录 | 历史难以追溯 |

---

## 3. 排查范围与检查清单

### 3.1 文档系统检查清单

#### 3.1.1 AI 记忆层（`ai-context/`）

- [ ] **CONTEXT.md**
  - [ ] TL;DR 是否准确反映项目现状
  - [ ] 项目阶段是否与实际一致（Phase X.Y）
  - [ ] 技术栈版本是否与 package.json 一致
  - [ ] 下一步任务是否与 CURRENT.md 一致
  - [ ] 协作偏好是否明确（开发节奏、设计风格）
  - [ ] 快速导航链接是否有效
  - [ ] Token 效率（是否 < 3000 tokens）
  - [ ] 最后更新时间是否准确

- [ ] **CURRENT.md**
  - [ ] 本周时间范围是否准确
  - [ ] Day-by-day 日志是否完整（无遗漏天数）
  - [ ] 是否有冗余内容（重复日志、过度详细）
  - [ ] 是否有已完成但未标记为 ✅ 的任务
  - [ ] 技术亮点是否记录
  - [ ] 问题与解决方案是否记录
  - [ ] Token 效率（是否 < 2500 tokens）
  - [ ] 是否需要归档（超过 1 个月）

- [ ] **archive/**
  - [ ] 归档文件命名是否规范（YYYY-MM.md）
  - [ ] 是否有超过 6 个月的归档（考虑压缩或删除）
  - [ ] 归档文件是否可读（未损坏）

#### 3.1.2 开发文档层（`development/`）

- [ ] **frontend/components.md**
  - [ ] 是否包含所有组件（对比 `src/components/`）
  - [ ] 组件文档是否完整（Props、用途、示例）
  - [ ] 是否有已删除但未从文档中移除的组件

- [ ] **frontend/pages.md**
  - [ ] 是否包含所有页面（对比 `src/features/`）
  - [ ] 页面文档是否完整（路由、状态、特殊逻辑）

- [ ] **frontend/troubleshooting.md**
  - [ ] 是否有已修复但未从文档中移除的问题
  - [ ] 问题是否按优先级排序
  - [ ] 是否有链接到具体的 troubleshooting 详细文档

- [ ] **DEVELOPMENT.md**
  - [ ] 代码规范是否明确
  - [ ] Git 规范是否明确
  - [ ] 是否包含目录结构说明

- [ ] **SLASH_COMMANDS.md**
  - [ ] 命令总览表是否完整
  - [ ] 每个命令是否有详细文档
  - [ ] 参数说明是否准确
  - [ ] 使用示例是否有效

#### 3.1.3 架构层（`architecture/`）

- [ ] **OVERVIEW.md**
  - [ ] 系统架构图是否存在且准确
  - [ ] 技术选型是否与实际一致
  - [ ] 设计模式是否明确

- [ ] **tech-stack.md**
  - [ ] 版本是否与 package.json 一致
  - [ ] 选型理由是否记录
  - [ ] 是否有月度审查记录

- [ ] **adr/**
  - [ ] 重大决策是否有 ADR
  - [ ] ADR 格式是否规范（使用 template.md）
  - [ ] ADR 索引（README.md）是否完整

#### 3.1.4 项目层（`project/`）

- [ ] **vision.md**
  - [ ] 个人愿景是否明确
  - [ ] 设计风格偏好是否详细

- [ ] **design.md**
  - [ ] 功能设计是否与实际一致
  - [ ] 页面设计是否完整

- [ ] **ROADMAP.md**
  - [ ] 开发路线图是否与实际进度一致
  - [ ] Phase 是否与 CONTEXT.md 一致

- [ ] **DEPLOYMENT.md**
  - [ ] 部署流程是否准确
  - [ ] 环境变量是否记录

### 3.2 代码系统检查清单

- [ ] **代码质量**
  - [ ] ESLint errors 数量（应 = 0）
  - [ ] ESLint warnings 数量（应 < 10）
  - [ ] 未使用依赖数量（执行 `pnpm exec depcheck`）
  - [ ] 代码 TODO/FIXME 注释数量

- [ ] **依赖健康**
  - [ ] 过时依赖数量（执行 `pnpm outdated`）
  - [ ] 安全漏洞数量（执行 `pnpm audit`）
  - [ ] Major 版本更新（谨慎评估）
  - [ ] Minor/Patch 版本更新（推荐更新）

- [ ] **性能指标**
  - [ ] 构建时间（执行 `time pnpm build`）
  - [ ] 构建产物大小
  - [ ] Lighthouse 分数（如果有）

- [ ] **目录结构**
  - [ ] 是否符合 Feature-based 架构
  - [ ] 是否有临时文件（temp*, test*, .DS_Store）
  - [ ] 是否有未使用的文件/目录

### 3.3 Git 历史检查清单

- [ ] **Commit 质量**
  - [ ] 是否使用 Conventional Commits 格式
  - [ ] Commit message 是否清晰（不是"fix", "update"等）
  - [ ] Commit 粒度是否合理（不是一次修改 100+ 文件）

- [ ] **分支状态**
  - [ ] 未提交文件数量（执行 `git status --short`）
  - [ ] 未推送 commit 数量
  - [ ] 是否有未合并的分支

- [ ] **Git 配置**
  - [ ] .gitignore 是否完整（排除 node_modules, dist, .env 等）
  - [ ] Git hooks 是否配置（如 pre-commit）

---

## 4. 详细排查步骤

### 4.1 使用 `/audit` 命令自动排查

**推荐方式**：使用 `/audit` 命令自动执行大部分检查

```bash
# 快速检查（5-10 分钟）
/audit --quick

# 完整检查（15-20 分钟）
/audit --full

# 安全检查（重点安全漏洞）
/audit --security
```

`/audit` 会自动检查：
1. 代码质量（ESLint, depcheck）
2. 依赖健康（pnpm outdated, pnpm audit）
3. 性能指标（构建时间）
4. 待办事项（CURRENT.md + 代码 TODO）
5. 文档同步（components.md, pages.md vs 代码）
6. Git 状态（未提交文件, commits 统计）

**输出**：生成 `docs/reports/audit-YYYY-MM-DD.md` 报告

### 4.2 手动深度排查（`/audit` 未覆盖的部分）

#### 4.2.1 文档一致性检查

**检查 CONTEXT.md 与实际是否一致**：

```bash
# 1. 读取 CONTEXT.md 中的"项目阶段"
grep "项目阶段" docs/ai-context/CONTEXT.md

# 2. 读取 CURRENT.md 中的"当前阶段"
grep "当前阶段" docs/ai-context/CURRENT.md

# 3. 对比是否一致
```

**检查 tech-stack.md 与 package.json 版本一致性**：

```bash
# 1. 读取 tech-stack.md 中的版本
grep "React" docs/architecture/tech-stack.md

# 2. 读取 package.json 中的版本
grep "react" package.json

# 3. 对比差异
```

**检查文档链接有效性**：

```bash
# 查找所有 Markdown 链接
grep -r "\[.*\](.*\.md)" docs/ | grep -v "http"

# 手动验证每个链接是否存在
```

#### 4.2.2 文档冗余检查

**检查 CURRENT.md 冗余内容**：

1. 读取 CURRENT.md
2. 查找重复的日志条目
3. 查找过度详细的描述（如完整的代码片段）
4. 查找已完成但仍在"本周任务"中的项目

**检查文档重复**：

```bash
# 查找内容相似的文档
grep -r "组件快速参考" docs/

# 检查是否有多个文档记录相同内容
```

#### 4.2.3 代码冗余检查

**检查未使用的文件**：

```bash
# 查找所有 .jsx 文件
find src/ -name "*.jsx"

# 检查是否有未被引用的文件（手动或使用工具）
```

**检查未使用的依赖**：

```bash
cd apps/frontend && pnpm exec depcheck
```

**注意**：depcheck 可能有误报，需人工判断

#### 4.2.4 Git 历史质量检查

**检查最近 20 个 commit**：

```bash
git log -20 --oneline
```

**检查点**：
- Commit message 是否规范（type(scope): subject）
- 是否有连续的"fix", "update"等低质量 message
- 是否有单个 commit 修改过多文件

**检查 commit 粒度**：

```bash
# 查看最近 10 个 commit 的文件数
for i in {1..10}; do
  echo "Commit $i:"
  git log -1 --skip=$((i-1)) --stat --oneline
done
```

如果有 commit 修改 > 50 个文件，可能粒度太大。

### 4.3 排查优先级

**🔴 Priority 1（立即排查）**：
1. CONTEXT.md 与实际不符
2. ESLint errors > 0
3. 安全漏洞（Critical/High）
4. 构建失败
5. 未提交文件 > 20 个

**🟡 Priority 2（本周排查）**：
1. CURRENT.md 冗余内容
2. 文档未与代码同步（components.md）
3. 未使用依赖 > 5 个
4. 过时依赖 > 10 个
5. Commit message 不规范

**🟢 Priority 3（月度排查）**：
1. tech-stack.md 版本不一致
2. archive 超过 6 个月
3. 构建时间 > 5 秒
4. 产物大小 > 3MB

---

## 5. 优化策略

### 5.1 文档优化

#### 5.1.1 删除冗余内容

**CURRENT.md 优化**：

```markdown
# ❌ 冗余示例（删除）

### Day 1 - 2025-11-23

**完成工作**：
- ✅ 修改 Header.jsx 的第 45 行，将 padding 从 20px 改为 24px
- ✅ 修改 Header.css 的第 12 行，将 margin 从 10px 改为 12px
- ✅ 修改 App.jsx 的第 78 行，添加了一个新的 import 语句
  ```jsx
  import { Header } from './components/Header';
  ```
- ✅ 测试了 Header 组件，发现样式正常
- ✅ 提交了代码
- ✅ 推送到远程
- ✅ 检查了 CI/CD 状态

# ✅ 优化后（简洁）

### Day 1 - 2025-11-23

**完成工作**：
- ✅ 优化 Header 组件样式（padding 24px, margin 12px）
```

**原则**：
- 删除过度详细的日志（如完整代码片段）
- 合并重复条目
- 保留关键信息（做了什么、为什么、结果如何）

#### 5.1.2 合并重复内容

**示例**：

```markdown
# ❌ 重复（合并）

**遇到的问题**：
- 问题 1: Header 样式问题
- 问题 2: Header 样式问题（移动端）
- 问题 3: Header 样式问题（平板）

# ✅ 合并后

**遇到的问题**：
- Header 响应式样式问题（移动端、平板）
```

#### 5.1.3 更新过时内容

**检查点**：
- CONTEXT.md 的项目阶段（是否 Phase 1 → Phase 2）
- tech-stack.md 的版本（是否与 package.json 一致）
- ROADMAP.md 的进度（是否完成了某个 Phase）

**更新流程**：
1. 执行 `/audit` 发现不一致
2. 手动更新对应文档
3. 执行 `/checkpoint --commit` 提交

#### 5.1.4 补充缺失内容

**检查点**：
- components.md 是否包含所有组件
- pages.md 是否包含所有页面
- ADR 是否记录所有重大决策

**补充流程**：
1. 执行 `/audit` 发现缺失
2. 手动补充对应文档
3. 执行 `/checkpoint --commit` 提交

### 5.2 代码优化

#### 5.2.1 修复 ESLint 错误

```bash
# 查看所有 errors
cd apps/frontend && pnpm lint

# 自动修复（部分）
cd apps/frontend && pnpm lint --fix

# 手动修复剩余 errors
```

#### 5.2.2 删除未使用的依赖

```bash
# 检查未使用依赖
cd apps/frontend && pnpm exec depcheck

# 删除未使用依赖（需人工判断）
pnpm remove <package-name>
```

**注意**：depcheck 可能有误报，删除前需确认

#### 5.2.3 更新过时依赖

```bash
# 查看过时依赖
cd apps/frontend && pnpm outdated

# 更新 Patch 版本（安全）
pnpm update

# 更新 Minor 版本（推荐）
pnpm update --latest <package-name>

# 更新 Major 版本（谨慎，需测试）
pnpm add <package-name>@latest
```

**策略**：
- **Patch**：立即更新（bug 修复，向后兼容）
- **Minor**：推荐更新（新功能，向后兼容）
- **Major**：谨慎评估（可能有破坏性变更，需要测试）

#### 5.2.4 清理临时文件

```bash
# 查找临时文件
find . -name "temp*" -o -name "test*" -o -name ".DS_Store"

# 删除临时文件
find . -name "temp*" -delete
find . -name ".DS_Store" -delete

# 添加到 .gitignore
echo "temp*" >> .gitignore
echo ".DS_Store" >> .gitignore
```

### 5.3 Git 优化

#### 5.3.1 规范 Commit Message

**检查最近 10 个 commit**：

```bash
git log -10 --oneline
```

**如果发现不规范 commit**：

```bash
# 交互式 rebase（谨慎使用）
git rebase -i HEAD~10

# 修改 commit message（将 pick 改为 reword）
```

**注意**：如果 commit 已推送到远程，**不要** rebase，会导致历史冲突。

#### 5.3.2 提交未提交文件

```bash
# 查看未提交文件
git status --short

# 添加文件
git add .

# 创建 commit
git commit -m "chore: 清理未提交文件"

# 推送到远程
git push
```

#### 5.3.3 清理未追踪文件

```bash
# 查看未追踪文件
git status --short | grep "^??"

# 删除未追踪文件（谨慎）
git clean -fd

# 或添加到 .gitignore
```

---

## 6. 恢复机制

### 6.1 从误操作中恢复

#### 场景 1: 误删除文档

**问题**：不小心删除了 CONTEXT.md

**恢复步骤**：

```bash
# 1. 检查 Git 历史
git log --all --full-history -- docs/ai-context/CONTEXT.md

# 2. 找到最后一次包含该文件的 commit（假设是 abc1234）
git show abc1234:docs/ai-context/CONTEXT.md

# 3. 恢复文件
git checkout abc1234 -- docs/ai-context/CONTEXT.md

# 4. 提交恢复
git add docs/ai-context/CONTEXT.md
git commit -m "fix(docs): 恢复误删除的 CONTEXT.md"
```

#### 场景 2: 文档内容损坏

**问题**：CURRENT.md 内容混乱，需要回滚

**恢复步骤**：

```bash
# 1. 查看 CURRENT.md 的修改历史
git log -p docs/ai-context/CURRENT.md

# 2. 找到最后一次正常的 commit（假设是 def5678）
git show def5678:docs/ai-context/CURRENT.md > /tmp/CURRENT.md

# 3. 对比当前版本和历史版本
diff docs/ai-context/CURRENT.md /tmp/CURRENT.md

# 4. 恢复到历史版本（如果确认需要）
git checkout def5678 -- docs/ai-context/CURRENT.md

# 5. 提交恢复
git add docs/ai-context/CURRENT.md
git commit -m "fix(docs): 回滚 CURRENT.md 到正常状态"
```

#### 场景 3: 代码误操作

**问题**：修改了大量文件，但想放弃所有修改

**恢复步骤**：

```bash
# 1. 查看未提交的修改
git status

# 2. 放弃所有未提交的修改（谨慎！）
git reset --hard HEAD

# 3. 清理未追踪文件（谨慎！）
git clean -fd
```

**警告**：`git reset --hard` 会永久丢失未提交的修改，使用前请三思。

### 6.2 从混乱中系统性恢复

#### 6.2.1 评估混乱程度

执行 `/audit --full` 生成完整报告，评估：

- **代码质量分数**：< 70 = 严重混乱
- **依赖健康分数**：有 Critical 安全漏洞 = 严重混乱
- **文档同步分数**：缺失 > 5 个文档 = 混乱
- **Git 状态**：未提交文件 > 20 个 = 混乱

#### 6.2.2 制定恢复计划

**Priority 1（立即执行）**：
1. 修复 Critical 安全漏洞
2. 修复构建失败
3. 恢复 CONTEXT.md 准确性

**Priority 2（本周执行）**：
1. 优化 CURRENT.md 冗余内容
2. 更新文档同步（components.md, pages.md）
3. 修复 ESLint errors

**Priority 3（下周执行）**：
1. 更新过时依赖
2. 清理未使用依赖
3. 优化 Git 历史

#### 6.2.3 执行恢复

**使用 Slash Commands 自动恢复**：

```bash
# 1. 执行每周优化（删除 CURRENT.md 冗余）
/weekly

# 2. 执行月度归档（如果 CURRENT.md 超过 1 个月）
/monthly

# 3. 重新执行 /audit 验证恢复
/audit --full
```

**手动恢复**：
1. 按照第 5 节"优化策略"逐项优化
2. 每完成一项，执行 `/checkpoint --commit`
3. 最后执行 `/end --push` 推送所有修复

### 6.3 备份与回滚

#### 6.3.1 创建备份分支

**在重大优化前创建备份**：

```bash
# 创建备份分支
git checkout -b backup-before-optimization

# 推送到远程
git push origin backup-before-optimization

# 切回主分支
git checkout main
```

#### 6.3.2 回滚到备份

**如果优化失败，回滚到备份**：

```bash
# 1. 切换到备份分支
git checkout backup-before-optimization

# 2. 强制覆盖主分支（谨慎！）
git branch -f main backup-before-optimization

# 3. 切回主分支
git checkout main

# 4. 推送到远程（谨慎！）
git push origin main --force
```

**警告**：`git push --force` 会覆盖远程历史，仅在个人项目中使用。

---

## 7. 预防措施

### 7.1 建立定期检查机制

**每周日晚上**：

```bash
# 1. 快速健康检查
/audit --quick

# 2. 优化文档
/weekly --push
```

**每月 1 日**：

```bash
# 1. 完整健康检查
/audit --full

# 2. 归档和优化
/monthly --push
```

### 7.2 建立自动化预防

#### 7.2.1 Git Hooks

**pre-commit hook**（提交前自动检查）：

```bash
# 创建 .git/hooks/pre-commit
#!/bin/bash

# 检查 ESLint
echo "Running ESLint..."
cd apps/frontend && pnpm lint
if [ $? -ne 0 ]; then
    echo "❌ ESLint failed. Please fix errors before committing."
    exit 1
fi

# 检查未追踪的大文件
echo "Checking for large files..."
find . -type f -size +10M | grep -v ".git" | grep -v "node_modules"
if [ $? -eq 0 ]; then
    echo "⚠️  Found large files. Consider adding to .gitignore."
fi

echo "✅ Pre-commit checks passed."
exit 0
```

**使 hook 可执行**：

```bash
chmod +x .git/hooks/pre-commit
```

#### 7.2.2 CI/CD 自动检查

**GitHub Actions 示例**（`.github/workflows/audit.yml`）：

```yaml
name: Weekly Audit

on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日 00:00 执行

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - name: Install dependencies
        run: pnpm install
      - name: Run audit
        run: |
          cd apps/frontend
          pnpm lint
          pnpm outdated || true
          pnpm audit
```

### 7.3 建立文档更新规范

**强制规则**：
- ✅ 新增组件必须更新 components.md
- ✅ 新增页面必须更新 pages.md
- ✅ Bug 修复必须创建 troubleshooting 文档
- ✅ 重大决策必须创建 ADR
- ✅ 每次会话结束必须执行 `/end`
- ✅ 每周日必须执行 `/weekly`
- ✅ 每月初必须执行 `/monthly`

**检查机制**：
- 每周执行 `/audit` 检查文档同步
- 发现缺失立即补充

### 7.4 建立代码质量门禁

**门禁规则**：
- ❌ ESLint errors > 0 → 禁止 commit
- ❌ 安全漏洞（Critical/High）> 0 → 禁止部署
- ❌ 构建失败 → 禁止 commit
- ⚠️ ESLint warnings > 50 → 警告但允许 commit

**实施方式**：
- Git pre-commit hook（本地检查）
- CI/CD pipeline（远程检查）

---

## 8. 实际案例

### 案例 1: CURRENT.md 膨胀导致 Token 过高

**背景**：
- 项目运行 2 个月，CURRENT.md 从未归档
- Token 从 ~2000 增长到 ~8000
- AI 恢复上下文时间从 30 秒增加到 2 分钟

**混乱信号**：
- `/start` 执行时间明显变长
- `/audit` 报告：CURRENT.md Token > 8000

**排查步骤**：
1. 执行 `/audit --full` 确认问题
2. 读取 CURRENT.md，发现大量冗余日志
3. 检查最后归档时间（2 个月前）

**优化策略**：
1. 执行 `/monthly` 强制归档
   - 归档到 `archive/2025-11.md`
   - 创建新的 CURRENT.md 模板
2. 手动优化归档文件（删除过度详细的日志）
3. 更新 CONTEXT.md 的最后更新时间

**结果**：
- CURRENT.md Token：~8000 → ~1500（减少 81%）
- AI 恢复上下文时间：2 分钟 → 30 秒
- `/start` 执行速度恢复正常

**预防措施**：
- 建立每月执行 `/monthly` 的习惯
- 每周执行 `/audit --quick` 检查 Token

---

### 案例 2: 文档与代码不同步

**背景**：
- 新增了 5 个组件，但未更新 components.md
- AI 推荐使用不存在的旧组件
- 开发者查找组件文档困难

**混乱信号**：
- AI 建议使用已删除的组件
- `/audit` 报告：components.md 缺失 5 个组件

**排查步骤**：
1. 执行 `/audit --full`
2. 对比 `src/components/` 和 `components.md`
3. 发现缺失：MasonryGrid, LightboxModal, VideoPlayer, AnimatedCounter, ProgressBar

**优化策略**：
1. 手动补充 components.md
   - 添加 5 个新组件的文档（Props, 用途, 示例）
2. 删除已删除组件的文档（如果有）
3. 执行 `/checkpoint --commit` 提交更新

**结果**：
- components.md 与代码 100% 同步
- AI 推荐正确的组件
- 开发者查找组件更高效

**预防措施**：
- 建立"新增组件必须更新 components.md"的规范
- 每周执行 `/audit` 检查文档同步
- 使用 `/checkpoint` 时自动检查文档更新

---

### 案例 3: 依赖安全漏洞导致生产事故

**背景**：
- 项目使用 React Router 7.9.6（存在 Critical 安全漏洞）
- 漏洞被攻击者利用，导致 XSS 攻击
- 生产环境紧急回滚

**混乱信号**：
- 生产环境出现异常行为
- 安全扫描工具报警：Critical 漏洞
- `/audit --security` 报告：1 个 Critical 漏洞

**排查步骤**：
1. 执行 `/audit --security` 确认漏洞
2. 查看 `pnpm audit` 详细报告
3. 确认漏洞影响范围（XSS 攻击）

**优化策略**：
1. 立即更新 React Router 到 7.9.8（漏洞已修复）
   ```bash
   pnpm add react-router@7.9.8
   ```
2. 执行回归测试（确保无破坏性变更）
3. 执行 `/checkpoint --commit` 提交更新
4. 立即部署到生产环境

**结果**：
- 漏洞修复，生产环境恢复正常
- 安全扫描通过

**预防措施**：
- 建立每周执行 `/audit --security` 的习惯
- 配置 GitHub Dependabot 自动检测漏洞
- Critical 漏洞立即修复（不等待下次迭代）

---

### 案例 4: Git 历史混乱导致难以追溯

**背景**：
- 最近 20 个 commit 都是"fix", "update", "test"
- 无法追溯某个功能是何时添加的
- Code review 困难

**混乱信号**：
- `git log -20 --oneline` 输出全是低质量 message
- 无法通过 commit message 找到特定功能

**排查步骤**：
1. 执行 `git log -20 --oneline`
2. 发现大量"fix", "update"等低质量 message
3. 检查 commit 粒度（部分 commit 修改 > 50 文件）

**优化策略**：
1. **不修改已推送的 commit**（会导致历史冲突）
2. 从现在开始使用 Conventional Commits 格式
3. 配置 Git hook 强制检查 commit message 格式
4. 使用 `/checkpoint --commit` 和 `/end --push` 自动生成规范 commit

**结果**：
- 新的 commit 全部规范化
- Git 历史可读性提升
- Code review 效率提升

**预防措施**：
- 强制使用 Conventional Commits 格式
- 配置 commitlint + husky 自动检查
- 使用 Slash Commands 生成 commit（避免手动写）

---

## 9. 总结

### 9.1 排查核心要点

1. **使用 `/audit` 自动化排查**
   - 快速检查：`/audit --quick`（每周）
   - 完整检查：`/audit --full`（每月）
   - 安全检查：`/audit --security`（发现漏洞立即执行）

2. **分优先级处理**
   - 🔴 Priority 1：立即处理（安全漏洞、构建失败）
   - 🟡 Priority 2：本周处理（文档不同步、代码质量）
   - 🟢 Priority 3：月度处理（性能优化、历史清理）

3. **系统性恢复**
   - 评估混乱程度（`/audit` 报告）
   - 制定恢复计划（按优先级）
   - 执行恢复（自动化 + 手动）
   - 验证恢复（重新执行 `/audit`）

### 9.2 预防核心要点

1. **建立定期检查机制**
   - 每周日：`/audit --quick` + `/weekly --push`
   - 每月初：`/audit --full` + `/monthly --push`

2. **建立自动化预防**
   - Git pre-commit hook（ESLint、大文件检查）
   - CI/CD pipeline（依赖安全扫描）

3. **建立文档更新规范**
   - 新增组件 → 更新 components.md
   - Bug 修复 → 创建 troubleshooting 文档
   - 重大决策 → 创建 ADR

### 9.3 关键成功要素

✅ **定期排查**：预防胜于治疗
✅ **自动化优先**：使用 `/audit` 和 Slash Commands
✅ **分优先级**：先解决 Critical，再优化 Warning
✅ **系统性恢复**：不要头痛医头，脚痛医脚
✅ **建立预防**：防止问题再次发生

---

## 📚 附录

### 附录 A: `/audit` 完整输出示例

```markdown
### 📋 项目健康度审计报告

**审计时间**: 2025-11-23 14:30（第 47 周）

---

#### 1️⃣ 代码质量 [✅优秀]

- **ESLint**: 0 errors, 3 warnings
- **未使用依赖**: 2 个（react-icons, lodash-es）
- **评分**: 92/100

---

#### 2️⃣ 依赖健康 [⚠️良好]

- **总依赖**: 45 个
- **可更新**: 8 个（Major: 1, Minor: 5, Patch: 2）
- **安全漏洞**: 0 个
- **版本一致性**: tech-stack.md vs package.json
  - 不一致: 2 个依赖（React, Vite）

**建议更新**：
🟡 Minor（推荐）:
- Vite: 7.2.0 → 7.3.0（性能优化，建议更新）
- React Router: 7.9.6 → 7.9.8（bug 修复）

---

#### 3️⃣ 性能指标 [✅优秀]

- **Lighthouse**: 95/100（上周 93，↑ 2 分）
- **构建时间**: 2.1s（上周 2.5s，↑ 19%）
- **产物大小**: 1.5MB

---

#### 4️⃣ 待办事项

- **总计**: 12 项待办（P0: 2, P1: 5, P2: 5）
- **代码 TODO**: 8 个
- **代码 FIXME**: 3 个

**本周优先级**（P0 待办）：
- [ ] Vercel 部署
- [ ] 真实设备测试

---

#### 5️⃣ 文档同步 [⚠️需更新]

- **组件文档**: 9/10 已文档化（遗漏 1 个）
- **页面文档**: 7/7 已文档化
- **tech-stack.md**: ⚠️ 需更新（2 个版本不一致）

**遗漏文档**：
- MasonryGrid 组件（新增，未在 components.md 中）

---

#### 6️⃣ Git 状态

- **未提交文件**: 0 个
- **本周 commits**: 15 次

---

### 📊 综合健康度评分

**总评**: 88/100 [⚠️良好]

---

### 🎯 行动建议（优先级排序）

#### 本周完成（High）
1. 更新 Minor/Patch 依赖（安全且无破坏性）
2. 补充 MasonryGrid 组件文档
3. 处理 P0 待办事项

#### 下周计划（Medium）
1. 评估 Major 版本更新（需要测试）
2. 清理未使用的依赖（react-icons, lodash-es）

---

**报告路径**: `docs/reports/audit-2025-11-23.md`
```

### 附录 B: 快速排查命令清单

```bash
# ===== 文档检查 =====
# 检查 CURRENT.md Token（估算，每行 ~10 tokens）
wc -l docs/ai-context/CURRENT.md

# 检查文档链接有效性
grep -r "\[.*\](.*\.md)" docs/ | grep -v "http"

# 检查文档重复
grep -r "组件快速参考" docs/

# ===== 代码检查 =====
# ESLint 检查
cd apps/frontend && pnpm lint

# 未使用依赖
cd apps/frontend && pnpm exec depcheck

# 过时依赖
cd apps/frontend && pnpm outdated

# 安全漏洞
cd apps/frontend && pnpm audit

# 代码 TODO/FIXME
grep -r "TODO\|FIXME" apps/frontend/src --include="*.jsx" --include="*.js"

# ===== Git 检查 =====
# 未提交文件
git status --short

# 最近 20 个 commit
git log -20 --oneline

# 本周 commits 统计
WEEK_START=$(date -d "last monday" +%Y-%m-%d)
git log --since="$WEEK_START" --oneline | wc -l

# ===== 性能检查 =====
# 构建时间
cd apps/frontend && time pnpm build

# 产物大小
du -sh apps/frontend/dist
```

### 附录 C: 恢复命令清单

```bash
# ===== 文件恢复 =====
# 恢复误删除的文件
git log --all --full-history -- <file-path>
git checkout <commit-hash> -- <file-path>

# 回滚文件到某个 commit
git show <commit-hash>:<file-path> > /tmp/file
git checkout <commit-hash> -- <file-path>

# ===== 代码恢复 =====
# 放弃所有未提交的修改（谨慎！）
git reset --hard HEAD

# 清理未追踪文件（谨慎！）
git clean -fd

# ===== 备份恢复 =====
# 创建备份分支
git checkout -b backup-before-optimization
git push origin backup-before-optimization

# 回滚到备份分支（谨慎！）
git checkout backup-before-optimization
git branch -f main backup-before-optimization
git checkout main
git push origin main --force

# ===== Slash Commands 恢复 =====
# 强制归档（清理 CURRENT.md）
/monthly

# 优化文档（删除冗余）
/weekly

# 重新恢复上下文
/start --full
```

---

**维护者**: Stephen Kaylon Chan
**创建日期**: 2025-11-23
**版本**: v1.0
**最后更新**: 2025-11-23
